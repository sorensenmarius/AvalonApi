# ASP.NET Core (.NET Framework)
# Build and test ASP.NET Core projects targeting the full .NET Framework.
# Add steps that publish symbols, save build artifacts, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/dotnet-core

trigger:
- master

pool:
  vmImage: windows-latest
steps:
- task: NuGetCommand@2  
  displayName: 'Restore nuget packages' 
- task: MSBuild@1
  displayName: 'Build the project'
- task: DotNetCoreCLI@2
  displayName: 'Initialize EntityFrameworkCore'
  inputs:
    command: custom
    custom: tool
    arguments: 'install --global dotnet-ef'
- task: DotNetCoreCLI@2
  displayName: 'Create migration'
  inputs:
    command: custom
    custom: ef
    arguments: 'migrations script --verbose --project "$(BuildSourcesDirectory)\MultiplayerAvalon.EntityFrameworkCore\MultiplayerAvalon.EntityFrameworkCore.csproj" -i -o migration.sql' 

- task: SqlAzureDacpacDeployment@1
  displayName: Install the database
  inputs:
    azureSubscription: 'Avalon Service Connection'
    AuthenticationType: 'server'
    ServerName: 'multiplayeravalondb.database.windows.net'
    DatabaseName: 'MultiplayerAvalonDb'
    SqlUsername: 'dbadmin'
    SqlPassword: 'Avalon2020'
    deployType: 'DacpacTask'
    DeploymentAction: 'Publish'
    DacpacFile: 'migration.sql'
    IpDetectionMethod: 'AutoDetect'